pipeline {
    agent any

    parameters {
        string(name: 'INCREMENT_TYPE', defaultValue: 'patch', description: 'Increment type (patch, minor, major)')
    }

    stages {
        stage('Release Preparation') {
            steps {
                script {
                    // Install jq
                    sh "apt-get update && apt-get install -y jq"

                    // Set up variables
                    def commit_hash = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    def tag_name = "dev.${commit_hash}"
                    def version = sh(script: 'jq -r .version package.json', returnStdout: true).trim()

                    // Release preparation steps
                    sh """
                        set -e
                        release-it --increment=${INCREMENT_TYPE} --release-version=${version}
                        release-it --no-npm --ci --git.tagName=${version}.${tag_name}
                    """
                }
            }
        }
    }
}
